name: Lint Naming Rules Inline

on:
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Run naming linter
        id: lint
        run: |
          python3 LinterNamingConventions.py || true

      - name: Read lint suggestions
        id: read_suggestions
        run: |
          if [ -f lint_suggestions.txt ]; then
            # We use base64 to avoid issues with special characters/newlines in the output
            echo "content=$(cat lint_suggestions.txt | base64 -w 0)" >> $GITHUB_OUTPUT
            echo "has_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi

      - name: Post inline suggestions on PR
        if: ${{ steps.read_suggestions.outputs.has_errors == 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 1. Decode the Base64 content
            const raw = Buffer.from("${{ steps.read_suggestions.outputs.content }}", 'base64').toString('utf-8');
            const lines = raw.split("\n");

            for (const line of lines) {
              if (!line.trim()) continue;

              // 2. Parse our custom format: FILE|LINE|CODE
              // We use split with limit to handle code that might contain pipes
              const parts = line.split("|");
              if (parts.length < 3) continue;

              const path = parts[0].trim();
              const lineNumber = parseInt(parts[1].trim());
              
              // Rejoin the rest in case the code line contained pipes
              const codeSuggestion = parts.slice(2).join("|");

              // 3. Create the Review Comment with the SUGGESTION BLOCK
              await github.rest.pulls.createReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                commit_id: context.payload.pull_request.head.sha,
                path: path,
                line: lineNumber,
                side: "RIGHT",
                body: "```suggestion\n" + codeSuggestion + "\n```"
              });
            }
            
            // Fail the workflow to block the PR until fixed
            core.setFailed("Naming conventions violations found.");