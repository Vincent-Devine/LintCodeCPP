name: Lint Naming Rules Inline

on:
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      # Identify changed files in the PR
      - name: Find changed C++ files
        uses: tj-actions/changed-files@v44
        id: changes
        with:
          files_ignore: |
            *.md
            *.txt
          files: |
            **.cpp
            **.hpp
            **.h

      # Run naming linter on changed files
      - name: Run naming linter on changed files
        id: lint
        # Combine added and modified files into a single space-separated string
        env:
          CHANGED_FILES: ${{ steps.changes.outputs.modified_files }} ${{ steps.changes.outputs.added_files }}
        run: |
          # The script now takes the file list as arguments
          # We allow failure (|| true) so the comment posting step can run.
          python3 LinterNamingConventions.py $CHANGED_FILES || true

      # Read suggestions
      - name: Read lint suggestions
        id: read_suggestions
        run: |
          if [ -f lint_suggestions.txt ]; then
            # Using base64 to safely handle newlines and special characters in the code suggestions
            echo "content=$(cat lint_suggestions.txt | base64 -w 0)" >> $GITHUB_OUTPUT
            echo "has_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi

      # Post inline suggestions
      - name: Post inline suggestions on PR
        if: ${{ steps.read_suggestions.outputs.has_errors == 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            // 1. Decode the Base64 content from the Python linter
            const raw = Buffer.from("${{ steps.read_suggestions.outputs.content }}", 'base64').toString('utf-8');
            const suggestions = raw.split("\n").filter(line => line.trim());

            // 2. Get the list of modified files in the PR
            const prFiles = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });

            const modifiedFiles = prFiles.data.map(f => f.filename);

            // 3. Post only inline suggestions for files modified in this PR
            for (const line of suggestions) {
              const parts = line.split("|");
              if (parts.length < 3) continue;

              const path = parts[0].trim();
              const lineNumber = parseInt(parts[1].trim());
              const codeSuggestion = parts.slice(2).join("|");

              // Ignore suggestions for files not in the PR
              if (!modifiedFiles.includes(path)) continue;

              await github.rest.pulls.createReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                commit_id: context.payload.pull_request.head.sha,
                path: path,
                line: lineNumber,
                side: "RIGHT",
                body: "```suggestion\n" + codeSuggestion + "\n```"
              });
            }

            // Fail the workflow to block the PR
            core.setFailed("Naming conventions violations found.");
