name: Lint Naming Rules Inline

on:
  pull_request:
    branches: [ main, master ]

permissions:
  contents: read
  pull-requests: write

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      - name: Get list of modified files
        id: modified_files
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prFiles = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.payload.pull_request.number
            });
            const files = prFiles.data
              .map(f => f.filename)
              .filter(f => f.endsWith('.h') || f.endsWith('.hpp') || f.endsWith('.cpp'));
            console.log("Modified files:", files);
            core.setOutput("files", files.join(" "));

      - name: Run naming linter on modified files
        id: lint
        run: |
          echo "Modified files: ${{ steps.modified_files.outputs.files }}"
          python3 LinterNamingConventions.py ${{ steps.modified_files.outputs.files }} || true

      - name: Read lint suggestions
        id: read_suggestions
        run: |
          if [ -f lint_suggestions.txt ]; then
            echo "content=$(cat lint_suggestions.txt | base64 -w 0)" >> $GITHUB_OUTPUT
            echo "has_errors=true" >> $GITHUB_OUTPUT
          else
            echo "has_errors=false" >> $GITHUB_OUTPUT
          fi

      - name: Post inline suggestions on PR
        if: ${{ steps.read_suggestions.outputs.has_errors == 'true' }}
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const raw = Buffer.from("${{ steps.read_suggestions.outputs.content }}", 'base64').toString('utf-8');
            const suggestions = raw.split("\n").filter(line => line.trim());

            for (const line of suggestions) {
              const parts = line.split("|");
              if (parts.length < 3) continue;

              const path = parts[0].trim();
              const lineNumber = parseInt(parts[1].trim());
              const codeSuggestion = parts.slice(2).join("|");

              await github.rest.pulls.createReviewComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                commit_id: context.payload.pull_request.head.sha,
                path: path,
                line: lineNumber,
                side: "RIGHT",
                body: "```suggestion\n" + codeSuggestion + "\n```"
              });
            }

            core.setFailed("Naming conventions violations found.");
